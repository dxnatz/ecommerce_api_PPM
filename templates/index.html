<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Login E-commerce</title>
</head>
<body>
    <h1>Login</h1>

    <form id="login-form">
        <label for="username">Username:</label><br>
        <input type="text" id="username" required><br>

        <label for="password">Password:</label><br>
        <input type="password" id="password" required><br><br>

        <button type="submit">Login</button>
    </form>

    <div id="response" style="margin-top: 20px; color: green;"></div>

    <div id="content" style="display:none;">
        <hr>
        <h2>Lista Prodotti</h2>

        <table border="1" id="product-table" style="display:none;">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Prezzo</th>
                    <th>Descrizione</th>
                    <th>Azione</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h2>Contenuto Carrello</h2>
        <table border="1" id="cart-table">
            <thead>
                <tr>
                    <th>Prodotto</th>
                    <th>Quantità</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <button id="logout-btn" style="margin-top:20px;">Logout</button>
    </div>

<script>
    const form = document.getElementById("login-form");
    const responseDiv = document.getElementById("response");
    const productTable = document.getElementById("product-table");
    const contentDiv = document.getElementById("content");
    const logoutBtn = document.getElementById("logout-btn");

    // Funzione per mostrare contenuti dopo login
    function mostraContenuto() {
        contentDiv.style.display = "block";
        form.style.display = "none";
        responseDiv.innerText = "";
    }

    // Funzione per mostrare il login
    function mostraLogin() {
        contentDiv.style.display = "none";
        form.style.display = "block";
        responseDiv.innerText = "";
    }

    // Verifica se il token è valido chiamando un endpoint protetto
    function verificaToken(token) {
        return fetch("http://127.0.0.1:8000/api/products/", {
            method: "GET",
            headers: { "Authorization": `Bearer ${token}` }
        }).then(res => {
            if (res.ok) return true;
            else throw new Error("Token non valido");
        });
    }

    function caricaProdotti() {
        const token = localStorage.getItem("token");

        fetch("http://127.0.0.1:8000/api/products/", {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${token}`
            }
        })
        .then(res => {
            if (!res.ok) throw new Error("Errore nel recupero dei prodotti");
            return res.json();
        })
        .then(data => {
            const tbody = document.querySelector("#product-table tbody");
            tbody.innerHTML = "";

            data.forEach(prodotto => {
                const riga = document.createElement("tr");
                riga.innerHTML = `
                    <td>${prodotto.name}</td>
                    <td>${prodotto.price}</td>
                    <td>${prodotto.description}</td>
                    <td><button class="add-to-cart" data-id="${prodotto.id}">Aggiungi al carrello</button></td>
                `;
                tbody.appendChild(riga);
            });

            productTable.style.display = "table";
        })
        .catch(err => {
            alert(err.message);
        });
    }

    function rimuoviDalCarrello(itemId) {
    const token = localStorage.getItem("token");

    fetch(`http://127.0.0.1:8000/api/cart/items/${itemId}/delete/`, {
        method: "DELETE",
        headers: {
            "Authorization": `Bearer ${token}`
        }
    })
    .then(res => {
        if (!res.ok) throw new Error("Errore nella rimozione");
        alert("Prodotto rimosso dal carrello");
        caricaCarrello();  // aggiorna la tabella dopo la rimozione
    })
    .catch(err => {
        alert(err.message);
    });
}

    function aggiungiAlCarrello(productId) {
    const token = localStorage.getItem("token");

    const bodyData = { product_id: productId, quantity: 1 };  // qui product_id
    console.log("Body richiesta:", bodyData);

    fetch("http://127.0.0.1:8000/api/cart/items/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(bodyData)
    })
    .then(res => {
        if (!res.ok) {
            throw new Error(`Errore ${res.status}: ${res.statusText}`);
        }
        return res.json();
    })
    .then(data => {
        console.log("Risposta:", data);
        alert("Prodotto aggiunto al carrello!");
        caricaCarrello();  // Ricarica il carrello dopo l'aggiunta
    })
    .catch(err => {
        console.error("Errore:", err);
        alert("Errore nell'aggiunta al carrello: " + err.message);
    });
}

    function decrementItem(id) {
    const token = localStorage.getItem("token");

    fetch(`http://127.0.0.1:8000/api/cart/items/${id}/decrement/`, {
        method: "POST",
        headers: {
            "Authorization": `Bearer ${token}`
        }
    })
    .then(res => {
        if (!res.ok) throw new Error("Errore nel decremento quantità");
        return res.json();
    })
    .then(data => {
        alert(data.detail);
        caricaCarrello();  // aggiorna il carrello dopo la modifica
    })
    .catch(err => {
        alert(err.message);
    });
}

    function rimuoviTutti(productId) {
    const token = localStorage.getItem("token");

    fetch(`http://127.0.0.1:8000/api/cart/items/remove_all/${productId}/`, {
        method: "DELETE",
        headers: {
            "Authorization": `Bearer ${token}`
        }
    })
    .then(res => {
        if (!res.ok) {
            throw new Error(`Errore ${res.status}: ${res.statusText}`);
        }
        return res.text(); // o .json() se rispondi con JSON
    })
    .then(() => {
        alert("Prodotto rimosso completamente dal carrello!");
        caricaCarrello(); // aggiorna la tabella
    })
    .catch(err => {
        console.error("Errore:", err);
        alert("Errore nella rimozione: " + err.message);
    });
}

    function caricaCarrello() {
    const token = localStorage.getItem("token");

    fetch("http://127.0.0.1:8000/api/cart/", {
        method: "GET",
        headers: {
            "Authorization": `Bearer ${token}`
        }
    })
    .then(res => {
        if (!res.ok) throw new Error("Errore nel recupero del carrello");
        return res.json();
    })
    .then(data => {
        const tbody = document.querySelector("#cart-table tbody");
        tbody.innerHTML = "";

        const prodottiRaggruppati = {};

        data.items.forEach(item => {
            const nomeProdotto = item.product && item.product.name ? item.product.name : "Prodotto sconosciuto";
            if (prodottiRaggruppati[nomeProdotto]) {
                prodottiRaggruppati[nomeProdotto].quantity += item.quantity;
            } else {
                prodottiRaggruppati[nomeProdotto] = {
                    quantity: item.quantity,
                    cartItemId: item.id,       // per "Rimuovi uno"
                    productId: item.product.id // per "Rimuovi tutti"
                };
            }
        });

        for (const [nome, info] of Object.entries(prodottiRaggruppati)) {
            const riga = document.createElement("tr");
            riga.innerHTML = `
                <td>${nome}</td>
                <td>${info.quantity}</td>
                <td>
                    <button class="remove-one" data-id="${info.cartItemId}">Rimuovi uno</button>
                    <button class="remove-all" data-product-id="${info.productId}">Rimuovi tutti</button>
                </td>
            `;
            tbody.appendChild(riga);
        }

        // Listener per "Rimuovi uno"
        document.querySelectorAll(".remove-one").forEach(button => {
            button.addEventListener("click", (e) => {
                const id = e.target.getAttribute("data-id");
                decrementItem(id);
            });
        });

        // Listener per "Rimuovi tutti"
        document.querySelectorAll(".remove-all").forEach(button => {
            button.addEventListener("click", (e) => {
                const productId = e.target.getAttribute("data-product-id");
                rimuoviTutti(productId);
            });
        });
    })
    .catch(err => {
        alert(err.message);
    });
}


    // Controllo all’avvio se token esiste e validità
    const token = localStorage.getItem("token");
    if (token) {
        verificaToken(token)
        .then(() => {
            mostraContenuto();
            caricaProdotti();
            caricaCarrello();
        })
        .catch(() => {
            localStorage.removeItem("token");
            mostraLogin();
        });
    } else {
        mostraLogin();
    }

    form.addEventListener("submit", function(event) {
        event.preventDefault();

        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        fetch("http://127.0.0.1:8000/api/users/token/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ username, password })
        })
        .then(res => {
            if (!res.ok) throw new Error("Credenziali errate");
            return res.json();
        })
        .then(data => {
            localStorage.setItem("token", data.access);
            responseDiv.innerText = "Login effettuato con successo!";
            responseDiv.style.color = "green";

            mostraContenuto();
            caricaProdotti();
            caricaCarrello();
        })
        .catch(err => {
            responseDiv.innerText = err.message;
            responseDiv.style.color = "red";
        });
    });

    document.querySelector("#cart-table tbody").addEventListener("click", function(event) {
    if (event.target.classList.contains("remove-from-cart")) {
        const itemId = event.target.getAttribute("data-id");
        rimuoviDalCarrello(itemId);
    }
    });

    // Listener per aggiungere prodotti al carrello
    document.querySelector("#product-table tbody").addEventListener("click", function(event) {
        if (event.target.classList.contains("add-to-cart")) {
            const productId = event.target.getAttribute("data-id");
            aggiungiAlCarrello(productId);
        }
    });

    // Logout
    logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("token");
        mostraLogin();
    });

</script>

</body>
</html>